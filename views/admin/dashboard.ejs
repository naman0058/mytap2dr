<%- include('../layout.ejs') %>
<style>
  :root{ --brand:#0b76e0; --brand-ink:#0a5fb4; --ink:#0f172a; --muted:#64748b; --border:#e2e8f0; --bg:#f8fafc; --card:#fff; }
  body{background:var(--bg)}
  .page{max-width:1100px;margin:0 auto;padding:16px}
  .head{display:flex;flex-wrap:wrap;gap:10px;align-items:center;background:#eef6ff;border:1px solid #dbeafe;border-radius:16px;padding:12px;margin:6px 0 16px}
  .head h1{margin:0;color:var(--brand-ink);font-size:20px}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#fff;border:1px solid #dbeafe;border-radius:999px;padding:6px 10px;font-size:13px}
  .grid{display:grid;gap:12px}
  .cards{grid-template-columns:repeat(3,1fr)}
  @media(max-width:820px){ .cards{grid-template-columns:1fr} }
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.03)}
  .stat-title{font-size:12px;color:var(--muted);margin:0 0 6px}
  .stat-value{font-size:28px;font-weight:800;margin:0}
  .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;text-decoration:none;color:var(--ink);font-weight:700}
  .btn.primary{background:var(--brand);color:#fff;border-color:transparent}
  .select{border:1px solid #dbeafe;background:#fff;border-radius:8px;padding:6px 10px}
  .muted{color:var(--muted)}
</style>

<div class="page">
  <div class="head">
    <h1>Dashboard</h1>

    <!-- Logged-in identity -->
    <span class="pill">
      <strong><%= admin?.full_name || doctor?.full_name %></strong>
      <span class="muted">(<%= admin?.email || '' %>)</span>
    </span>

    <!-- Hospital scope -->
    <span class="pill">
      Hospital: <strong><%= admin?.hospital || '—' %></strong>
    </span>

    <!-- Active doctor switcher (within hospital) -->
    <form method="post" action="/admin/switch" class="pill" style="gap:6px">
      <label for="doctorSelect" class="muted" style="font-weight:700">Doctor</label>
      <select id="doctorSelect" name="doctor_id" class="select" onchange="this.form.submit()">
        <% (admin?.doctors || []).forEach(function(d){ %>
          <option value="<%= d.doctor_id %>" <%= d.doctor_id === (admin?.active_doctor_id || doctor?.doctor_id) ? 'selected' : '' %>>
            <%= d.doctor_name %><%= d.hospital_name ? ' — ' + d.hospital_name : '' %><%= d.city ? ' (' + d.city + ')' : '' %>
          </option>
        <% }) %>
      </select>
    </form>

    <span class="pill">Today <%= dates.today %></span>
  </div>

  <div class="grid cards">
    <div class="card">
      <p class="stat-title">Yesterday</p>
      <p class="stat-value"><%= counts.yesterday.total %></p>
      <div class="stat-title">Booked: <%= counts.yesterday.booked %> · Completed: <%= counts.yesterday.completed %></div>
    </div>
    <div class="card">
      <p class="stat-title">Today</p>
      <p class="stat-value"><%= counts.today.total %></p>
      <div class="stat-title">Booked: <%= counts.today.booked %> · Completed: <%= counts.today.completed %></div>
    </div>
    <div class="card">
      <p class="stat-title">Tomorrow</p>
      <p class="stat-value"><%= counts.tomorrow.total %></p>
      <div class="stat-title">Booked: <%= counts.tomorrow.booked %> · Completed: <%= counts.tomorrow.completed %></div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <p class="stat-title">3-Day Overview</p>
    <canvas id="bar" height="120"></canvas>
  </div>

  <div class="actions">
    <!-- bookings view and CSV use the active doctor in session -->
    <a class="btn primary" href="/admin/bookings?date=<%= dates.today %>">My Appointments</a>
    <a class="btn" href="/admin/download/today.csv">Download Today CSV</a>
    <form method="post" action="/admin/logout" style="display:inline">
      <button class="btn" type="submit">Logout</button>
    </form>
  </div>
</div>

<!-- Chart.js (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  const labels = ['Yesterday', 'Today', 'Tomorrow'];
  const totals = [<%= counts.yesterday.total %>, <%= counts.today.total %>, <%= counts.tomorrow.total %>];
  const ctx = document.getElementById('bar').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Appointments', data: totals }] },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
    }
  });
</script>
